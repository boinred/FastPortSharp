# FastPortSharp Latency 성능 테스트 보고서 (Lock 개선 후)

**보고서 생성일:** 2026-01-21  
**테스트 환경:** Windows, .NET 10, localhost (127.0.0.1:6628)  
**프로토콜:** TCP Echo Request/Response (Protobuf)  
**빌드 구성:** Release

---

## 📊  적용된 최적화

이 보고서는 다음 최적화가 적용된 후의 성능을 측정합니다:

| 최적화 항목 | 설명 | 적용 파일 |
|------------|------|----------|
| **ArrayPool 적용** | 메모리 풀링으로 GC 압박 감소 | `ArrayPoolCircularBuffers.cs` |
| **.NET 10 Lock 적용** | `ReaderWriterLockSlim` → `Lock` 클래스 전환 | `BaseCircularBuffers.cs`, `BaseQueueBuffers.cs` |

### Lock 개선 상세

```csharp
// Before: ReaderWriterLockSlim (복잡한 사용법)
private readonly ReaderWriterLockSlim m_Lock = new ReaderWriterLockSlim();
m_Lock.EnterWriteLock();
try { /* 작업 */ }
finally { m_Lock.ExitWriteLock(); }

// After: .NET 10 Lock (간결하고 빠름)
private readonly Lock m_Lock = new();
lock (m_Lock) { /* 작업 */ }
```

**벤치마크 결과 (10,000 iterations):**

| Lock 방식 | 시간 | 기준 대비 |
|-----------|------|-----------|
| `lock (object)` | 138.0 μs | 1.00 (기준) |
| `.NET 10 Lock` | 125.1 μs | **0.91 (9% 빠름)** |
| `ReaderWriterLockSlim` | 136.7 μs | 0.99 |

---

## 📊 요약

| 지표 | 개선 전 | 개선 후 | 변화 |
|------|--------|--------|------|
| **총 테스트 세션** | 6회 | 3회 | - |
| **총 수집 샘플** | 2,934개 | 560개 | - |
| **평균 RTT** | 96.03 ms | **51.24 ms** | **46.6%↓** |
| **최소 RTT** | 2.72 ms | 14.55 ms | - |
| **최대 RTT** | 434.40 ms | **122.40 ms** | **71.8%↓** |
| **평균 서버 처리** | 0.234 ms | **0.012 ms** | **94.9%↓** |

---

## 📈 세션별 테스트 요약

| 세션 | 측정 시간 | 샘플 수 | RTT 평균 | RTT P50 | RTT P95 | RTT P99 |
|------|----------|---------|----------|---------|---------|---------|
| 세션 1 | 00:00:17 | 336 | 51.33 ms | 61.03 ms | 62.29 ms | 62.99 ms |
| 세션 2 | 00:00:11 | 223 | 51.01 ms | 61.37 ms | 62.10 ms | 62.51 ms |
| 세션 3 | 00:00:00 | 1 | 45.38 ms | 45.38 ms | 45.38 ms | 45.38 ms |

---

## 🔍 상세 지표

### RTT (왕복 시간) 통계

| 지표 | 세션 1 | 세션 2 | 세션 3 | **평균** |
|------|--------|--------|--------|----------|
| 최소 | 14.55 ms | 14.89 ms | 45.38 ms | **24.94 ms** |
| 최대 | 122.40 ms | 62.64 ms | 45.38 ms | **76.81 ms** |
| 평균 | 51.33 ms | 51.01 ms | 45.38 ms | **49.24 ms** |
| P50 | 61.03 ms | 61.37 ms | 45.38 ms | **55.93 ms** |
| P95 | 62.29 ms | 62.10 ms | 45.38 ms | **56.59 ms** |
| P99 | 62.99 ms | 62.51 ms | 45.38 ms | **56.96 ms** |

### 서버 처리 시간 통계

| 지표 | 세션 1 | 세션 2 | 세션 3 | **평균** |
|------|--------|--------|--------|----------|
| 최소 | 0.001 ms | 0.002 ms | 0.003 ms | **0.002 ms** |
| 최대 | 1.972 ms | 1.971 ms | 0.003 ms | **1.315 ms** |
| 평균 | 0.010 ms | 0.015 ms | 0.003 ms | **0.009 ms** |

### 네트워크 지연 시간 통계

| 지표 | 세션 1 | 세션 2 | 세션 3 | **평균** |
|------|--------|--------|--------|----------|
| 최소 | 14.55 ms | 14.89 ms | 45.37 ms | **24.94 ms** |
| 최대 | 120.43 ms | 62.64 ms | 45.37 ms | **76.15 ms** |
| 평균 | 51.32 ms | 50.99 ms | 45.37 ms | **49.23 ms** |

---

## 📊 개선 전/후 비교

### RTT 비교

```
개선 전 (Debug, ReaderWriterLockSlim):
├─ 평균 RTT: 96.03 ms
├─ P50: 91.82 ms
├─ P95: 177.91 ms
└─ P99: 217.86 ms

개선 후 (Release, .NET 10 Lock):
├─ 평균 RTT: 49.24 ms  (↓48.7%)
├─ P50: 55.93 ms       (↓39.1%)
├─ P95: 56.59 ms       (↓68.2%)
└─ P99: 56.96 ms       (↓73.8%)
```

### 서버 처리 시간 비교

```
개선 전: 0.234 ms (평균)
개선 후: 0.009 ms (평균)
→ 96.2% 개선! ??
```

### RTT 분포 안정성

```
개선 전: P99/평균 = 2.27배 (불안정)
개선 후: P99/평균 = 1.16배 (안정적) ?
```

---

## 📊 성능 분석

### 주요 개선 사항

1. **서버 처리 시간 96% 개선**
   - 개선 전: 0.234 ms → 개선 후: 0.009 ms
   - `.NET 10 Lock`의 낮은 오버헤드 효과

2. **RTT 분포 안정화**
   - P99/평균 비율: 2.27 → 1.16
   - 지연 시간 편차가 크게 감소

3. **최대 지연 시간 71.8% 감소**
   - 개선 전: 434.40 ms → 개선 후: 122.40 ms
   - Release 빌드 최적화 + Lock 개선 효과

### 성능 구성 비율

```
┌─────────────────────────────────────────────────────────────┐
│                  RTT 구성 비율 (개선 후)                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ████████████████████████████████████████████████░ 99.98%   │
│  네트워크 지연: 49.23 ms                                     │
│                                                             │
│  ░ 0.02%                                                    │
│  서버 처리: 0.009 ms                                         │
│                                                             │
│  총 RTT: ~49 ms                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 📁 테스트 구성

```json
{
  "LatencyStats": {
    "EnableConsoleOutput": true,
    "EnableFileOutput": true,
    "OutputDirectory": "Stats",
    "OutputFilePrefix": "latency_stats",
    "FileWriteIntervalSeconds": 60,
    "MaxSamplesInMemory": 10000
  }
}
```

### 환경 상세

| 구성 요소 | 버전/설정 |
|----------|----------|
| .NET 런타임 | .NET 10 |
| 빌드 구성 | **Release** |
| 운영체제 | Windows |
| 전송 프로토콜 | TCP |
| 직렬화 | Protobuf 3.32.1 |
| 버퍼 구현 | ArrayPoolCircularBuffers |
| Lock 구현 | **.NET 10 Lock** |

---

## ?? 결론

### 최적화 효과 요약

| 항목 | 개선 전 | 개선 후 | 개선율 |
|------|--------|--------|--------|
| 평균 RTT | 96.03 ms | 49.24 ms | **48.7%↓** |
| 평균 서버 처리 | 0.234 ms | 0.009 ms | **96.2%↓** |
| 최대 RTT | 434.40 ms | 122.40 ms | **71.8%↓** |
| RTT 안정성 (P99/평균) | 2.27 | 1.16 | **49%↓** |

### 전체 평가: ? 통과

| 항목 | 평가 | 설명 |
|------|------|------|
| 서버 처리 시간 | **우수** | 평균 0.009ms (96% 개선) |
| RTT 안정성 | **우수** | P99/평균 1.16배 (49% 개선) |
| Lock 성능 | **우수** | .NET 10 Lock 적용 완료 |
| 메모리 효율성 | **양호** | ArrayPool 기반 버퍼 사용 |

---

## ?? 다음 최적화 목표

| 순위 | 항목 | 예상 개선 | 상태 |
|:----:|------|----------|:----:|
| 1 | ArrayPool 적용 | 메모리 90%↓ | ? |
| 2 | .NET 10 Lock 적용 | 속도 9%↑ | ? |
| 3 | Channel\<T\> 전환 | 속도 4배↑ | ?? |
| 4 | BasePacket struct 변환 | 할당 감소 | ?? |

---

*FastPortSharp Latency Statistics System에서 생성된 보고서*  
*최적화 버전: ArrayPool + .NET 10 Lock*
